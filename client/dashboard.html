<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç”Ÿä¸­å¿ƒ - åˆ†ç§‘è‡ªé€‰ç³»ç»Ÿ</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/safeDOM.js"></script>
</head>
<body>
  <div class="page-wrapper">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
      <div class="container navbar-content">
        <a href="/dashboard.html" class="navbar-brand">
          ğŸ“š <span>åˆ†ç§‘è‡ªé€‰ç³»ç»Ÿ</span>
        </a>
        <div class="navbar-nav">
          <a href="/dashboard.html" class="nav-link active">é¦–é¡µ</a>
          <a href="/selection.html" class="nav-link">é€‰ç§‘</a>
          <div class="nav-user">
            <div class="nav-user-avatar" id="userAvatar">U</div>
            <span id="userName">ç”¨æˆ·</span>
            <a href="#" id="logoutBtn" style="color: var(--text-muted); margin-left: 0.5rem;">é€€å‡º</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
      <div class="container">
        <!-- æ¬¢è¿å¡ç‰‡ -->
        <div class="card mb-4 animate-fadeIn">
          <h2 style="margin-bottom: 0.5rem;">ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œ<span id="welcomeName">åŒå­¦</span></h2>
          <p style="color: var(--text-secondary);" id="welcomeClass">ç­çº§ä¿¡æ¯</p>
        </div>

        <!-- é€‰ç§‘çŠ¶æ€æç¤º -->
        <div id="statusAlert" class="alert alert-info mb-4">
          <span>â³ æ­£åœ¨åŠ è½½é€‰ç§‘çŠ¶æ€...</span>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
          <div class="stat-card animate-fadeIn">
            <div class="stat-value" id="statPhysicsHistory">-</div>
            <div class="stat-label">é¦–é€‰ç§‘ç›®</div>
          </div>
          <div class="stat-card animate-fadeIn" style="animation-delay: 0.1s;">
            <div class="stat-value" id="statElectives">-</div>
            <div class="stat-label">å†é€‰ç§‘ç›®</div>
          </div>
          <div class="stat-card animate-fadeIn" style="animation-delay: 0.2s;">
            <div class="stat-value" id="statStatus">-</div>
            <div class="stat-label">é€‰ç§‘çŠ¶æ€</div>
          </div>
        </div>

        <!-- æˆ‘çš„é€‰ç§‘è¯¦æƒ… -->
        <div class="card animate-fadeIn" style="animation-delay: 0.3s;">
          <div class="card-header">
            <h3 class="card-title">ğŸ“‹ æˆ‘çš„é€‰ç§‘</h3>
            <a href="/selection.html" class="btn btn-primary btn-sm" id="goSelectBtn">å»é€‰ç§‘</a>
          </div>

          <div id="selectionContent">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- é€‰ç§‘è¯´æ˜ -->
        <div class="card mt-4 animate-fadeIn" style="animation-delay: 0.4s;">
          <h3 class="card-title mb-2">ğŸ“– æ–°é«˜è€ƒ 3+1+2 é€‰ç§‘è¯´æ˜</h3>
          <div style="color: var(--text-secondary); line-height: 1.8;">
            <p><strong>3</strong>ï¼šè¯­æ–‡ã€æ•°å­¦ã€å¤–è¯­ï¼ˆå¿…è€ƒç§‘ç›®ï¼Œæ— éœ€é€‰æ‹©ï¼‰</p>
            <p><strong>1</strong>ï¼šç‰©ç†ã€å†å²ï¼ˆé¦–é€‰ç§‘ç›®ï¼ŒäºŒé€‰ä¸€ï¼‰</p>
            <p><strong>2</strong>ï¼šåŒ–å­¦ã€ç”Ÿç‰©ã€æ”¿æ²»ã€åœ°ç†ï¼ˆå†é€‰ç§‘ç›®ï¼Œå››é€‰äºŒï¼‰</p>
            <div class="alert alert-warning mt-3">
              <span>âš ï¸ é€‰ç§‘ç»“æœå°†å½±å“æœªæ¥é«˜è€ƒå’Œå¤§å­¦ä¸“ä¸šé€‰æ‹©ï¼Œè¯·æ…é‡è€ƒè™‘ï¼</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="js/api.js"></script>
  <script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!isLoggedIn()) {
      window.location.href = '/';
    }

    // è·å– projectId
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');

    if (projectId) {
      // æ›´æ–°æ‰€æœ‰å†…éƒ¨é“¾æ¥
      document.querySelectorAll('a[href^="/dashboard.html"], a[href^="/selection.html"]').forEach(link => {
        const url = new URL(link.href, window.location.origin);
        url.searchParams.set('projectId', projectId);
        link.href = url.toString();
      });
    } else {
       // å¦‚æœä¸æ˜¯åœ¨å¹³å°ç®¡ç†é¡µé¢ï¼Œä¸”ç¼ºå°‘projectIdï¼Œæç¤ºé”™è¯¯
       if (!window.location.pathname.includes('/platform/')) {
          alert('ç¼ºå°‘é¡¹ç›®ä¿¡æ¯ï¼Œè¯·é‡æ–°è¿›å…¥ç³»ç»Ÿ');
          window.location.href = '/platform/dashboard.html';
       }
    }

    if (!projectId) {
      alert('ç¼ºå°‘é¡¹ç›®ä¿¡æ¯ï¼Œè¯·é€šè¿‡æ­£ç¡®çš„æ–¹å¼è®¿é—®');
      window.location.href = '/';
    }

    const user = getCurrentUser();
    if (user && user.role === 'admin') {
      window.location.href = `/admin.html?projectId=${projectId}`;
    }

    // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
    if (user) {
      document.getElementById('userAvatar').textContent = user.name.charAt(0);
      document.getElementById('userName').textContent = user.name;
      document.getElementById('welcomeName').textContent = user.name;
      document.getElementById('welcomeClass').textContent = user.className ? `${user.className} | å­¦å·: ${user.studentId}` : `å­¦å·: ${user.studentId}`;
    }

    // é€€å‡ºç™»å½•
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      clearToken();
      window.location.href = projectId ? `/?projectId=${projectId}` : '/';
    });

    // åŠ è½½é€‰ç§‘çŠ¶æ€
    async function loadStatus() {
      const statusAlert = document.getElementById('statusAlert');
      const result = await api.selections.getStatus();

      if (result.code === 200) {
        const { open, message, startTime, endTime } = result.data;
        if (open) {
          statusAlert.className = 'alert alert-success mb-4';
          statusAlert.innerHTML = `<span>âœ… ${message} | æˆªæ­¢æ—¶é—´: ${endTime}</span>`;
        } else {
          statusAlert.className = 'alert alert-warning mb-4';
          statusAlert.innerHTML = `<span>â° ${message}</span>`;
        }
      }
    }

    // åŠ è½½æˆ‘çš„é€‰ç§‘
    async function loadMySelection() {
      const content = document.getElementById('selectionContent');
      const result = await api.selections.getMy();

        if (result.code === 200 && result.data) {
          const content = document.getElementById('selectionContent');
          safeDOM.empty(content);
          
          const sel = result.data;
          const card = safeDOM.createElement('div', {
            className: 'card',
            children: [
              safeDOM.createElement('h2', { text: 'å·²é€‰ç§‘ç›®' }),
              safeDOM.createElement('div', {
                className: 'selection-display',
                children: [
                  safeDOM.createElement('div', {
                    className: 'subject-item physics-history',
                    children: [
                      safeDOM.createElement('label', { text: 'é¦–é€‰ç§‘ç›®' }),
                      safeDOM.createElement('div', {
                        className: 'value',
                        text: sel.physicsHistorySubject?.name || '-'
                      })
                    ]
                  }),
                  safeDOM.createElement('div', {
                    className: 'subject-item electives',
                    children: [
                      safeDOM.createElement('label', { text: 'å†é€‰ç§‘ç›®' }),
                      safeDOM.createElement('div', {
                        className: 'value',
                        text: `${sel.electiveOneSubject?.name || '-'} + ${sel.electiveTwoSubject?.name || '-'}`
                      })
                    ]
                  }),
                  safeDOM.createElement('div', {
                    className: 'submit-time',
                    text: `æäº¤æ—¶é—´: ${sel.submittedAt ? new Date(sel.submittedAt).toLocaleString() : '-'}`
                  })
                ]
              }),
              safeDOM.createElement('a', {
                attrs: { href: 'selection.html' },
                className: 'btn btn-secondary',
                text: 'ä¿®æ”¹é€‰ç§‘'
              })
            ]
          });
          content.appendChild(card);
        } else {
          const content = document.getElementById('selectionContent');
          safeDOM.empty(content);
          
          const card = safeDOM.createElement('div', {
            className: 'card text-center',
            children: [
              safeDOM.createElement('p', { text: 'æ‚¨è¿˜æœªè¿›è¡Œé€‰ç§‘' }),
              safeDOM.createElement('a', {
                attrs: { href: 'selection.html' },
                className: 'btn btn-primary',
                text: 'å¼€å§‹é€‰ç§‘'
              })
            ]
          });
          content.appendChild(card);
        }
    }

    // åˆå§‹åŒ–
    loadStatus();
    loadMySelection();
  </script>
</body>
</html>
