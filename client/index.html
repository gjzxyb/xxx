<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç”Ÿåˆ†ç§‘è‡ªé€‰ç³»ç»Ÿ - ç™»å½•</title>
  <meta name="description" content="æ–°é«˜è€ƒ3+1+2é€‰ç§‘ç³»ç»Ÿï¼Œå­¦ç”Ÿè‡ªä¸»é€‰ç§‘å¹³å°">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="login-wrapper">
    <div class="card login-card animate-fadeIn">
      <div class="login-header">
        <div class="login-logo">ğŸ“š</div>
        <h1 class="login-title">åˆ†ç§‘è‡ªé€‰ç³»ç»Ÿ</h1>
        <p class="login-subtitle">æ–°é«˜è€ƒ 3+1+2 é€‰ç§‘å¹³å°</p>
      </div>

      <div id="alertBox" class="alert hidden"></div>

      <!-- ç™»å½•è¡¨å• -->
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">å­¦å· / è´¦å·</label>
          <input type="text" id="studentId" class="form-input" placeholder="è¯·è¾“å…¥å­¦å·" required>
        </div>
        <div class="form-group">
          <label class="form-label">å¯†ç </label>
          <input type="password" id="password" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç " required>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="rememberMe">
            <span style="color: var(--text-secondary); font-size: 0.9rem;">è®°ä½ç™»å½•çŠ¶æ€</span>
          </label>
        </div>
        <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
          ç™» å½•
        </button>
      </form>

      <div class="mt-3 text-center">
        <p style="color: var(--text-muted); font-size: 0.9rem;">
          è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" id="showRegister">ç«‹å³æ³¨å†Œ</a>
        </p>
      </div>

      <!-- æ³¨å†Œè¡¨å• -->
      <form id="registerForm" class="hidden">
        <div class="form-group">
          <label class="form-label">å­¦å·</label>
          <input type="text" id="regStudentId" class="form-input" placeholder="è¯·è¾“å…¥å­¦å·" required>
        </div>
        <div class="form-group">
          <label class="form-label">å§“å</label>
          <input type="text" id="regName" class="form-input" placeholder="è¯·è¾“å…¥çœŸå®å§“å" required>
        </div>
        <div class="form-group">
          <label class="form-label">ç­çº§</label>
          <input type="text" id="regClassName" class="form-input" placeholder="å¦‚ï¼šé«˜ä¸€(1)ç­">
        </div>
        <div class="form-group">
          <label class="form-label">å¯†ç </label>
          <input type="password" id="regPassword" class="form-input" placeholder="è¯·è®¾ç½®å¯†ç " required>
          <!-- å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨å®¹å™¨ -->
          <div id="regPasswordStrengthContainer"></div>
        </div>
        <div class="form-group">
          <label class="form-label">ç¡®è®¤å¯†ç </label>
          <input type="password" id="regConfirmPassword" class="form-input" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
        </div>
        <button type="submit" class="btn btn-success btn-lg" style="width: 100%;">
          æ³¨ å†Œ
        </button>
        <div class="mt-3 text-center">
          <a href="#" id="showLogin">è¿”å›ç™»å½•</a>
        </div>
      </form>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/passwordStrength.js"></script>
  <script>
    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    if (isLoggedIn()) {
      const user = getCurrentUser();
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('projectId');

      if (projectId) {
        // å¦‚æœURLä¸­æœ‰projectIdï¼Œé‡å®šå‘æ—¶ä¿ç•™å®ƒ
        if (user && user.role === 'admin') {
          window.location.href = `/admin.html?projectId=${projectId}`;
        } else {
          window.location.href = `/dashboard.html?projectId=${projectId}`;
        }
      } else {
        // å¦‚æœæ²¡æœ‰projectIdï¼Œé‡å®šå‘åˆ°å¹³å°é¦–é¡µè®©ç”¨æˆ·é€‰æ‹©é¡¹ç›®
        window.location.href = '/platform/dashboard.html';
      }
    }

    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const alertBox = document.getElementById('alertBox');

    // åˆå§‹åŒ–å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨
    let registerPasswordStrength = null;
    // åœ¨ DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof PasswordStrengthIndicator !== 'undefined') {
        registerPasswordStrength = new PasswordStrengthIndicator({
          passwordInput: document.getElementById('regPassword'),
          confirmInput: document.getElementById('regConfirmPassword'),
          container: document.getElementById('regPasswordStrengthContainer')
        });
      }
    });

    // æ˜¾ç¤ºæç¤º
    function showAlert(message, type = 'danger') {
      alertBox.textContent = message;
      alertBox.className = `alert alert-${type}`;
      alertBox.classList.remove('hidden');
      setTimeout(() => alertBox.classList.add('hidden'), 5000);
    }

    // æ£€æŸ¥æ³¨å†ŒçŠ¶æ€
    async function checkRegistrationStatus() {
      try {
        const response = await fetch('/api/auth/registration-status');
        const result = await response.json();

        if (result.code === 200 && result.data.registrationEnabled === false) {
          // æ³¨å†Œå·²å…³é—­
          const registerLink = document.getElementById('showRegister');
          registerLink.textContent = 'æ³¨å†Œå·²å…³é—­';
          registerLink.style.color = 'var(--text-muted)';
          registerLink.style.cursor = 'not-allowed';
          registerLink.style.pointerEvents = 'none';
          registerLink.style.textDecoration = 'none';
        }
      } catch (error) {
        console.error('æ£€æŸ¥æ³¨å†ŒçŠ¶æ€å¤±è´¥:', error);
        // å‘ç”Ÿé”™è¯¯æ—¶ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œé»˜è®¤å…è®¸æ³¨å†Œ
      }
    }

    // ç«‹å³æ‰§è¡Œæ£€æŸ¥
    checkRegistrationStatus();

    // åˆ‡æ¢è¡¨å• - æ˜¾ç¤ºæ³¨å†Œ
    function handleShowRegister(e) {
      e.preventDefault();
      loginForm.classList.add('hidden');
      registerForm.classList.remove('hidden');
    }
    document.getElementById('showRegister').addEventListener('click', handleShowRegister);

    // åˆ‡æ¢è¡¨å• - è¿”å›ç™»å½•
    document.getElementById('showLogin').addEventListener('click', (e) => {
      e.preventDefault();
      registerForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
    });

    // ç™»å½•
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = document.getElementById('studentId').value.trim();
      const password = document.getElementById('password').value;

      if (!studentId || !password) {
        showAlert('è¯·è¾“å…¥å­¦å·å’Œå¯†ç ');
        return;
      }

      // è·å– projectId (ä» URL å‚æ•°)
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('projectId');

      if (!projectId) {
        showAlert('ç¼ºå°‘é¡¹ç›®ä¿¡æ¯ï¼Œè¯·é€šè¿‡æ­£ç¡®çš„é“¾æ¥è®¿é—®');
        return;
      }

      const btn = loginForm.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'ç™»å½•ä¸­...';

      const result = await api.auth.login(studentId, password, projectId);

      if (result.code === 200) {
        setToken(result.data.token);
        setCurrentUser(result.data.user);

        // è·³è½¬æ—¶ä¿ç•™ projectId å‚æ•°
        if (result.data.user.role === 'admin') {
          window.location.href = `/admin.html?projectId=${projectId}`;
        } else {
          window.location.href = `/dashboard.html?projectId=${projectId}`;
        }
      } else {
        showAlert(result.message);
        btn.disabled = false;
        btn.textContent = 'ç™» å½•';
      }
    });

    // æ³¨å†Œ
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = document.getElementById('regStudentId').value.trim();
      const name = document.getElementById('regName').value.trim();
      const className = document.getElementById('regClassName').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;

      if (!studentId || !name || !password) {
        showAlert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯');
        return;
      }

      if (password !== confirmPassword) {
        showAlert('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
        return;
      }

      // éªŒè¯å¯†ç å¼ºåº¦
      if (registerPasswordStrength && !registerPasswordStrength.isValid()) {
        const errors = registerPasswordStrength.getErrors();
        showAlert('å¯†ç ä¸ç¬¦åˆè¦æ±‚ï¼š\n' + errors.join('ã€'));
        return;
      }

      const btn = registerForm.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'æ³¨å†Œä¸­...';

      const result = await api.auth.register({ studentId, name, className, password });

      if (result.code === 200) {
        setToken(result.data.token);
        setCurrentUser(result.data.user);
        window.location.href = '/dashboard.html';
      } else {
        showAlert(result.message);
        btn.disabled = false;
        btn.textContent = 'æ³¨ å†Œ';
      }
    });
  </script>
</body>
</html>
