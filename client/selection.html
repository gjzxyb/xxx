<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€‰ç§‘ - åˆ†ç§‘è‡ªé€‰ç³»ç»Ÿ</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/safeDOM.js"></script>
</head>
<body>
  <div class="page-wrapper">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
      <div class="container navbar-content">
        <a href="/dashboard.html" class="navbar-brand">
          ğŸ“š <span>åˆ†ç§‘è‡ªé€‰ç³»ç»Ÿ</span>
        </a>
        <div class="navbar-nav">
          <a href="/dashboard.html" class="nav-link">é¦–é¡µ</a>
          <a href="/selection.html" class="nav-link active">é€‰ç§‘</a>
          <div class="nav-user">
            <div class="nav-user-avatar" id="userAvatar">U</div>
            <span id="userName">ç”¨æˆ·</span>
            <a href="#" id="logoutBtn" style="color: var(--text-muted); margin-left: 0.5rem;">é€€å‡º</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
      <div class="container">
        <!-- çŠ¶æ€æç¤º -->
        <div id="statusAlert" class="alert alert-info mb-4">
          <span>â³ æ­£åœ¨åŠ è½½...</span>
        </div>

        <!-- å·²é€‰ç§‘ç›®æ‘˜è¦ -->
        <div class="selection-summary mb-4" id="selectionSummary">
          <div class="selection-summary-title">ğŸ“‹ å½“å‰é€‰æ‹©</div>
          <div class="selection-items">
            <div class="selection-item">
              <span class="selection-item-label">é¦–é€‰:</span>
              <span class="selection-item-value" id="selectedPH">æœªé€‰</span>
            </div>
            <div class="selection-item">
              <span class="selection-item-label">å†é€‰1:</span>
              <span class="selection-item-value" id="selectedE1">æœªé€‰</span>
            </div>
            <div class="selection-item">
              <span class="selection-item-label">å†é€‰2:</span>
              <span class="selection-item-value" id="selectedE2">æœªé€‰</span>
            </div>
          </div>
        </div>

        <!-- é¦–é€‰ç§‘ç›® - ç‰©ç†/å†å² -->
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">1ï¸âƒ£ é¦–é€‰ç§‘ç›®ï¼ˆäºŒé€‰ä¸€ï¼‰</h3>
            <span class="badge badge-info">å¿…é€‰</span>
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            ç‰©ç†æˆ–å†å²ï¼Œå†³å®šä½ çš„å¤§å­¦ä¸“ä¸šæ–¹å‘
          </p>
          <div class="subject-grid" id="physicsHistoryGrid">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- å†é€‰ç§‘ç›® - å››é€‰äºŒ -->
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">2ï¸âƒ£ å†é€‰ç§‘ç›®ï¼ˆå››é€‰äºŒï¼‰</h3>
            <span class="badge badge-info">é€‰2é—¨</span>
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            ä»åŒ–å­¦ã€ç”Ÿç‰©ã€æ”¿æ²»ã€åœ°ç†ä¸­é€‰æ‹©ä¸¤é—¨
          </p>
          <div class="subject-grid" id="electivesGrid">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- æäº¤æŒ‰é’® -->
        <div class="flex justify-between items-center" style="margin-top: 2rem;">
          <a href="/dashboard.html" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
          <div class="flex gap-2">
            <button class="btn btn-outline" id="cancelBtn" style="display: none;">å–æ¶ˆé€‰ç§‘</button>
            <button class="btn btn-success btn-lg" id="submitBtn" disabled>
              æäº¤é€‰ç§‘
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="js/api.js"></script>
  <script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!isLoggedIn()) {
      window.location.href = '/';
    }

    const user = getCurrentUser();
    if (user) {
      document.getElementById('userAvatar').textContent = user.name.charAt(0);
      document.getElementById('userName').textContent = user.name;
    }

    // è·å–å¹¶éªŒè¯ projectId
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');

    if (projectId) {
      // æ›´æ–°å¯¼èˆªé“¾æ¥
      document.querySelectorAll('a[href^="/dashboard.html"], a[href^="/selection.html"]').forEach(link => {
        const url = new URL(link.href, window.location.origin);
        url.searchParams.set('projectId', projectId);
        link.href = url.toString();
      });
    } else {
      // ç¼ºå°‘ projectIdï¼Œå°è¯•ä» localStorage è·å–ï¼ˆå¦‚æœåœ¨åŒä¸€ä¸ªä¼šè¯ä¸­ï¼‰
      // è¿™é‡Œç®€å•é‡å®šå‘å›å¹³å°é¦–é¡µè®©ç”¨æˆ·é‡æ–°è¿›å…¥
      alert('ç¼ºå°‘é¡¹ç›®ä¿¡æ¯ï¼Œè¯·é‡æ–°è¿›å…¥ç³»ç»Ÿ');
      window.location.href = '/platform/dashboard.html';
    }

    // é€€å‡ºç™»å½•
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      clearToken();
      window.location.href = projectId ? `/?projectId=${projectId}` : '/';
    });

    let selectionOpen = false;
    let hasExistingSelection = false;
    let subjects = []; // å­¦ç§‘åˆ—è¡¨

    // é€‰æ‹©çŠ¶æ€
    let selectedPhysicsHistory = null;
    let selectedElectives = [];

    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
    function formatDateTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // åŠ è½½é€‰ç§‘çŠ¶æ€
    async function loadStatus() {
      const statusAlert = document.getElementById('statusAlert');

      try {
        // ä½¿ç”¨selections APIè·å–é€‰ç§‘çŠ¶æ€
        const result = await api.selections.getStatus();

        if (result.code === 200) {
          const { open, message, startTime, endTime } = result.data;
          selectionOpen = open;

          if (open) {
            // é€‰ç§‘å¼€æ”¾ä¸­
            let displayMessage = 'âœ… é€‰ç§‘è¿›è¡Œä¸­';
            if (endTime) {
              displayMessage += ` | æˆªæ­¢æ—¶é—´: ${formatDateTime(endTime)}`;
            }
            statusAlert.className = 'alert alert-success mb-4';
            statusAlert.innerHTML = `<span>${displayMessage}</span>`;
          } else {
            // é€‰ç§‘æœªå¼€æ”¾
            statusAlert.className = 'alert alert-warning mb-4';
            statusAlert.innerHTML = `<span>â° ${message}</span>`;

            // æ˜¾ç¤ºå‹å¥½æç¤º
            if (startTime || endTime) {
              let detailMessage = message;
              if (startTime) detailMessage += '\nå¼€å§‹æ—¶é—´ï¼š' + formatDateTime(startTime);
              if (endTime) detailMessage += '\nç»“æŸæ—¶é—´ï¼š' + formatDateTime(endTime);

              setTimeout(() => {
                alert(detailMessage);
              }, 500);
            }
          }
        } else {
          statusAlert.className = 'alert alert-danger mb-4';
          statusAlert.innerHTML = `<span>âŒ ${result.message || 'è·å–é€‰ç§‘çŠ¶æ€å¤±è´¥'}</span>`;
        }
      } catch (error) {
        console.error('è·å–é€‰ç§‘çŠ¶æ€é”™è¯¯:', error);
        statusAlert.className = 'alert alert-danger mb-4';
        statusAlert.innerHTML = `<span>âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•</span>`;
      }
    }

    // åŠ è½½ç§‘ç›®
    async function loadSubjects() {
      const phGrid = document.getElementById('physicsHistoryGrid');
      const elGrid = document.getElementById('electivesGrid');

      try {
        console.log('å¼€å§‹åŠ è½½å­¦ç§‘æ•°æ®...');
        const result = await api.subjects.getAll({ active: true });
        console.log('å­¦ç§‘APIå“åº”:', result);

        if (result.code === 200) {
          subjects = result.data || [];
          console.log('å­¦ç§‘æ•°æ®:', subjects);

          if (subjects.length === 0) {
            phGrid.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">æš‚æ— ç§‘ç›®æ•°æ®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ </div>';
            elGrid.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">æš‚æ— ç§‘ç›®æ•°æ®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ </div>';
          } else {
            renderSubjects();
          }
        } else {
          console.error('åŠ è½½å­¦ç§‘å¤±è´¥:', result.message);
          phGrid.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--danger);">åŠ è½½å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
          elGrid.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--danger);">åŠ è½½å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
        }
      } catch (error) {
        console.error('åŠ è½½å­¦ç§‘å¼‚å¸¸:', error);
        phGrid.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--danger);">ç½‘ç»œé”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
        elGrid.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--danger);">ç½‘ç»œé”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
      }
    }

    // åŠ è½½å·²æœ‰é€‰ç§‘
    async function loadMySelection() {
      const result = await api.selections.getMy();

      if (result.code === 200 && result.data && result.data.status !== 'cancelled') {
        hasExistingSelection = true;
        selectedPhysicsHistory = result.data.physicsOrHistory;
        selectedElectives = [result.data.electiveOne, result.data.electiveTwo].filter(Boolean);

        document.getElementById('cancelBtn').style.display = 'block';
        document.getElementById('submitBtn').textContent = 'ä¿®æ”¹é€‰ç§‘';

        updateSummary();
        renderSubjects();
        checkSubmitReady();
      }
    }

    // æ¸²æŸ“ç§‘ç›®å¡ç‰‡
    function renderSubjects() {
      const phGrid = document.getElementById('physicsHistoryGrid');
      const elGrid = document.getElementById('electivesGrid');

      const phSubjects = subjects.filter(s => s.category === 'physics_history');
      const elSubjects = subjects.filter(s => s.category === 'four_electives');

      safeDOM.empty(phGrid);
      phSubjects.forEach(s => {
        phGrid.appendChild(createSubjectCard(s, 'ph'));
      });
      
      safeDOM.empty(elGrid);
      elSubjects.forEach(s => {
        elGrid.appendChild(createSubjectCard(s, 'el'));
      });

      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.subject-card').forEach(card => {
        card.addEventListener('click', () => handleSubjectClick(card));
      });
    }

    function createSubjectCard(subject, type) {
      const isSelected = type === 'ph'
        ? selectedPhysicsHistory === subject.id
        : selectedElectives.includes(subject.id);

      const isFull = subject.maxCapacity > 0 && subject.currentCount >= subject.maxCapacity;
      const remaining = subject.maxCapacity > 0
        ? subject.maxCapacity - subject.currentCount
        : 'ä¸é™';

      const card = document.createElement('div');
      card.className = `subject-card ${isSelected ? 'selected' : ''} ${isFull && !isSelected ? 'disabled' : ''}`;
      card.dataset.id = subject.id;
      card.dataset.type = type;
      card.dataset.name = subject.name;
      
      card.innerHTML = `
        <div class="subject-name">${subject.name}</div>
        <div class="subject-desc">${subject.description || ''}</div>
        <div class="subject-meta">
          <span class="subject-capacity">å‰©ä½™åé¢: ${remaining}</span>
          ${isSelected ? '<span class="badge badge-success">å·²é€‰</span>' : ''}
        </div>
      `;
      
      return card;
    }

    // ç‚¹å‡»ç§‘ç›®
    function handleSubjectClick(card) {
      if (!selectionOpen) {
        alert('é€‰ç§‘æœªå¼€æ”¾');
        return;
      }

      if (card.classList.contains('disabled')) {
        alert('è¯¥ç§‘ç›®åé¢å·²æ»¡');
        return;
      }

      const id = parseInt(card.dataset.id);
      const type = card.dataset.type;
      const name = card.dataset.name;

      if (type === 'ph') {
        // é¦–é€‰ç§‘ç›® - å•é€‰
        if (selectedPhysicsHistory === id) {
          selectedPhysicsHistory = null;
        } else {
          selectedPhysicsHistory = id;
        }
      } else {
        // å†é€‰ç§‘ç›® - æœ€å¤šé€‰2
        const index = selectedElectives.indexOf(id);
        if (index > -1) {
          selectedElectives.splice(index, 1);
        } else {
          if (selectedElectives.length >= 2) {
            alert('å†é€‰ç§‘ç›®æœ€å¤šé€‰æ‹©2é—¨');
            return;
          }
          selectedElectives.push(id);
        }
      }

      renderSubjects();
      updateSummary();
      checkSubmitReady();
    }

    // æ›´æ–°æ‘˜è¦
    function updateSummary() {
      const phSubject = subjects.find(s => s.id === selectedPhysicsHistory);
      const el1Subject = subjects.find(s => s.id === selectedElectives[0]);
      const el2Subject = subjects.find(s => s.id === selectedElectives[1]);

      document.getElementById('selectedPH').textContent = phSubject?.name || 'æœªé€‰';
      document.getElementById('selectedE1').textContent = el1Subject?.name || 'æœªé€‰';
      document.getElementById('selectedE2').textContent = el2Subject?.name || 'æœªé€‰';
    }

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æäº¤
    function checkSubmitReady() {
      const ready = selectedPhysicsHistory && selectedElectives.length === 2 && selectionOpen;
      document.getElementById('submitBtn').disabled = !ready;
    }

    // æäº¤é€‰ç§‘
    document.getElementById('submitBtn').addEventListener('click', async () => {
      if (!selectedPhysicsHistory || selectedElectives.length !== 2) {
        alert('è¯·å®Œæˆæ‰€æœ‰é€‰ç§‘');
        return;
      }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'æäº¤ä¸­...';

      const result = await api.selections.submit({
        physicsOrHistory: selectedPhysicsHistory,
        electiveOne: selectedElectives[0],
        electiveTwo: selectedElectives[1]
      });

      if (result.code === 200) {
        alert('é€‰ç§‘æäº¤æˆåŠŸï¼');
        window.location.href = `/dashboard.html?projectId=${projectId}`;
      } else {
        alert(result.message);
        btn.disabled = false;
        btn.textContent = hasExistingSelection ? 'ä¿®æ”¹é€‰ç§‘' : 'æäº¤é€‰ç§‘';
      }
    });

    // å–æ¶ˆé€‰ç§‘
    document.getElementById('cancelBtn').addEventListener('click', async () => {
      if (!confirm('ç¡®å®šè¦å–æ¶ˆé€‰ç§‘å—ï¼Ÿ')) return;

      const result = await api.selections.cancel();
      if (result.code === 200) {
        alert('é€‰ç§‘å·²å–æ¶ˆ');
        window.location.href = '/dashboard.html';
      } else {
        alert(result.message);
      }
    });

    // åˆå§‹åŒ–
    loadStatus().then(() => {
      loadSubjects();
      loadMySelection();
    });
  </script>
</body>
</html>
