<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå° - åˆ†ç§‘è‡ªé€‰ç³»ç»Ÿ</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="js/safeDOM.js"></script>
</head>
<body>
  <div class="page-wrapper">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
      <div class="container navbar-content">
        <a href="/admin.html" class="navbar-brand">
          ğŸ› ï¸ <span>ç®¡ç†åå°</span>
        </a>
        <div class="navbar-nav">
          <div class="nav-user">
            <div class="nav-user-avatar" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">A</div>
            <span id="adminName">ç®¡ç†å‘˜</span>
            <a href="#" id="logoutBtn" style="color: var(--text-muted); margin-left: 0.5rem;">é€€å‡º</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
      <div class="container">
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
          <button class="tab active" data-tab="overview">ğŸ“Š æ¦‚è§ˆ</button>
          <button class="tab" data-tab="time">â° æ—¶é—´è®¾ç½®</button>
          <button class="tab" data-tab="subjects">ğŸ“š ç§‘ç›®ç®¡ç†</button>
          <button class="tab" data-tab="students">ğŸ‘¥ å­¦ç”Ÿåˆ—è¡¨</button>
          <button class="tab" data-tab="stats">ğŸ“‹ é€‰ç§‘åˆ—è¡¨</button>
          <button class="tab" data-tab="combinations">ğŸ§© ç»„åˆç»Ÿè®¡</button>
        </div>

        <!-- æ¦‚è§ˆé¢æ¿ -->
        <div id="overviewPanel" class="tab-panel">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="statTotal">-</div>
              <div class="stat-label">å­¦ç”Ÿæ€»æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statSubmitted">-</div>
              <div class="stat-label">å·²é€‰ç§‘</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statPending">-</div>
              <div class="stat-label">æœªé€‰ç§‘</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statRate">-</div>
              <div class="stat-label">å®Œæˆç‡</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">å¿«æ·æ“ä½œ</h3>
            </div>
            <div class="flex gap-2" style="flex-wrap: wrap; align-items: center;">
              <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border-color);">
                <span style="font-weight: 500;">ğŸ”“ å…è®¸å­¦ç”Ÿæ³¨å†Œ</span>
                <label class="switch" style="position: relative; width: 50px; height: 26px; margin: 0;">
                  <input type="checkbox" id="registrationToggle" style="opacity: 0; width: 0; height: 0;">
                  <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-hover); transition: 0.3s; border-radius: 26px;"></span>
                </label>
              </div>
              <button class="btn btn-secondary" onclick="switchTab('time')">â° è®¾ç½®æ—¶é—´</button>
              <button class="btn btn-secondary" onclick="switchTab('subjects')">ğŸ“š ç®¡ç†ç§‘ç›®</button>
            </div>
            <style>
              .slider:before {
                position: absolute;
                content: "";
                height: 20px;
                width: 20px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: 0.3s;
                border-radius: 50%;
              }
              input:checked + .slider {
                background-color: var(--success);
              }
              input:checked + .slider:before {
                transform: translateX(24px);
              }
            </style>
          </div>
        </div>

        <!-- æ—¶é—´è®¾ç½®é¢æ¿ -->
        <div id="timePanel" class="tab-panel hidden">
          <div class="card" style="max-width: 500px;">
            <h3 class="card-title mb-3">â° é€‰ç§‘æ—¶é—´è®¾ç½®</h3>
            <form id="timeForm">
              <div class="form-group">
                <label class="form-label">å¼€å§‹æ—¶é—´</label>
                <input type="datetime-local" id="startTime" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">ç»“æŸæ—¶é—´</label>
                <input type="datetime-local" id="endTime" class="form-input" required>
              </div>
              <button type="submit" class="btn btn-success">ä¿å­˜è®¾ç½®</button>
            </form>
          </div>
        </div>

        <!-- ç§‘ç›®ç®¡ç†é¢æ¿ -->
        <div id="subjectsPanel" class="tab-panel hidden">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ“š ç§‘ç›®ç®¡ç†</h3>
              <button class="btn btn-primary btn-sm" id="addSubjectBtn">+ æ·»åŠ ç§‘ç›®</button>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>ç§‘ç›®åç§°</th>
                    <th>åˆ†ç±»</th>
                    <th>æè¿°</th>
                    <th>å®¹é‡é™åˆ¶</th>
                    <th>å·²é€‰äººæ•°</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="subjectsTable">
                  <tr><td colspan="7" class="text-center">åŠ è½½ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- å­¦ç”Ÿåˆ—è¡¨é¢æ¿ -->
        <div id="studentsPanel" class="tab-panel hidden">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ‘¥ å­¦ç”Ÿåˆ—è¡¨</h3>
              <div class="flex gap-2">
                <button class="btn btn-success btn-sm" id="addStudentBtn">+ æ·»åŠ å­¦ç”Ÿ</button>
                <button class="btn btn-primary btn-sm" id="importStudentsBtn">ğŸ“¤ å¯¼å…¥å­¦ç”Ÿ</button>
                <select id="classFilter" class="form-select" style="width: auto;">
                  <option value="">å…¨éƒ¨ç­çº§</option>
                </select>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>å­¦å·</th>
                    <th>å§“å</th>
                    <th>ç­çº§</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 180px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="studentsTable">
                  <tr><td colspan="5" class="text-center">åŠ è½½ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
            <div id="studentsPagination" class="flex justify-between items-center mt-3"></div>
          </div>
        </div>

        <!-- é€‰ç§‘åˆ—è¡¨é¢æ¿ -->
        <div id="statsPanel" class="tab-panel hidden">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ“‹ é€‰ç§‘åˆ—è¡¨</h3>
              <a href="#" class="btn btn-primary btn-sm" id="exportSelectionsBtn">ğŸ“¥ å¯¼å‡ºExcel</a>
            </div>

            <!-- ç­›é€‰å™¨ -->
            <div style="padding: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; background: var(--card-bg); border-bottom: 1px solid var(--border-color);">
              <div>
                <label style="display: block; font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">ç­çº§ç­›é€‰</label>
                <select id="selectionsClassFilter" class="form-input" style="width: 150px;">
                  <option value="">å…¨éƒ¨ç­çº§</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">ç»„åˆç­›é€‰</label>
                <select id="selectionsCombinationFilter" class="form-input" style="width: 200px;">
                  <option value="">å…¨éƒ¨ç»„åˆ</option>
                </select>
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th style="width: 80px;">å­¦å·</th>
                    <th style="width: 80px;">å§“å</th>
                    <th style="width: 100px;">ç­çº§</th>
                    <th style="width: 200px;">é€‰ç§‘ç»„åˆ</th>
                    <th style="width: 80px;">çŠ¶æ€</th>
                    <th style="width: 140px;">æäº¤æ—¶é—´</th>
                  </tr>
                </thead>
                <tbody id="selectionsTable">
                  <tr><td colspan="6" class="text-center">åŠ è½½ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
            <div id="selectionsPagination" class="flex justify-between items-center mt-3"></div>
          </div>
        </div>

        <!-- ç»„åˆç»Ÿè®¡é¢æ¿ -->
        <div id="combinationsPanel" class="tab-panel hidden">
          <div class="stats-grid mb-4">
            <div class="stat-card">
              <div class="stat-value" id="comboTotal">-</div>
              <div class="stat-label">å·²é€‰ç§‘æ€»äººæ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="comboPhysics">-</div>
              <div class="stat-label">ç‰©ç†æ–¹å‘</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="comboHistory">-</div>
              <div class="stat-label">å†å²æ–¹å‘</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="comboCount">-</div>
              <div class="stat-label">ç»„åˆæ•°é‡</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ§© é€‰ç§‘ç»„åˆåˆ†å¸ƒ</h3>
              <a href="#" class="btn btn-primary btn-sm" id="exportCombinationsBtn">ğŸ“¥ å¯¼å‡ºExcel</a>
            </div>
            <div id="combinationStats">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- æ·»åŠ /ç¼–è¾‘ç§‘ç›®å¼¹çª— -->
  <div class="modal-overlay" id="subjectModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">æ·»åŠ ç§‘ç›®</h3>
        <button class="modal-close" onclick="closeSubjectModal()">&times;</button>
      </div>
      <form id="subjectForm">
        <input type="hidden" id="subjectId">
        <div class="form-group">
          <label class="form-label">ç§‘ç›®åç§°</label>
          <input type="text" id="subjectName" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">åˆ†ç±»</label>
          <select id="subjectCategory" class="form-select" required>
            <option value="physics_history">ç‰©ç†/å†å²ï¼ˆé¦–é€‰ï¼‰</option>
            <option value="four_electives">å››é€‰äºŒï¼ˆå†é€‰ï¼‰</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">æè¿°</label>
          <input type="text" id="subjectDesc" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">æœ€å¤§å®¹é‡ï¼ˆ0è¡¨ç¤ºä¸é™ï¼‰</label>
          <input type="number" id="subjectCapacity" class="form-input" value="0" min="0">
        </div>
        <div class="flex justify-between">
          <button type="button" class="btn btn-secondary" onclick="closeSubjectModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-success">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- å¯¼å…¥å­¦ç”Ÿå¼¹çª— -->
  <div class="modal-overlay" id="importModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ“¤ å¯¼å…¥å­¦ç”Ÿ</h3>
        <button class="modal-close" onclick="closeImportModal()">&times;</button>
      </div>
      <div style="padding: 1rem;">
        <div class="form-group">
          <label class="form-label">é€‰æ‹© Excel æ–‡ä»¶</label>
          <input type="file" id="importFile" class="form-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">
            Excel æ–‡ä»¶éœ€åŒ…å«ä»¥ä¸‹åˆ—ï¼š<strong>å­¦å·</strong>ï¼ˆå¿…å¡«ï¼‰ã€<strong>å§“å</strong>ï¼ˆå¿…å¡«ï¼‰ã€<strong>ç­çº§</strong>ã€<strong>å¯†ç </strong>ï¼ˆé»˜è®¤123456ï¼‰
          </p>
        </div>
        <div class="flex gap-2 mb-3">
          <button type="button" class="btn btn-secondary btn-sm" onclick="downloadTemplate()">ğŸ“¥ ä¸‹è½½æ¨¡æ¿</button>
        </div>
        <div id="importPreview" style="display: none;">
          <h4 style="margin-bottom: 0.5rem;">é¢„è§ˆæ•°æ® (<span id="previewCount">0</span> æ¡)</h4>
          <div class="table-wrapper" style="max-height: 300px; overflow-y: auto;">
            <table>
              <thead>
                <tr>
                  <th>å­¦å·</th>
                  <th>å§“å</th>
                  <th>ç­çº§</th>
                  <th>å¯†ç </th>
                </tr>
              </thead>
              <tbody id="importPreviewTable"></tbody>
            </table>
          </div>
        </div>
        <div id="importResult" style="display: none; margin-top: 1rem;"></div>
        <div class="flex justify-between mt-3">
          <button type="button" class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
          <button type="button" class="btn btn-success" id="submitImportBtn" onclick="submitImport()" disabled>å¼€å§‹å¯¼å…¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ /ç¼–è¾‘å­¦ç”Ÿå¼¹çª— -->
  <div class="modal-overlay" id="studentModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="studentModalTitle">æ·»åŠ å­¦ç”Ÿ</h3>
        <button class="modal-close" onclick="closeStudentModal()">&times;</button>
      </div>
      <form id="studentForm">
        <input type="hidden" id="editStudentId">
        <div class="form-group">
          <label class="form-label">å­¦å· *</label>
          <input type="text" id="studentId" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">å§“å *</label>
          <input type="text" id="studentName" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">ç­çº§</label>
          <input type="text" id="studentClass" class="form-input">
        </div>
        <div class="form-group" id="passwordGroup">
          <label class="form-label">å¯†ç ï¼ˆç•™ç©ºåˆ™é»˜è®¤ä¸ºå­¦å·ï¼‰</label>
          <input type="password" id="studentPassword" class="form-input">
          <!-- å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨å®¹å™¨ -->
          <div id="studentPasswordStrengthContainer"></div>
        </div>
        <div class="flex justify-between">
          <button type="button" class="btn btn-secondary" onclick="closeStudentModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-success">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Custom Confirm Dialog -->
  <div class="modal-overlay" id="confirmDialog">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">âš ï¸ ç¡®è®¤æ“ä½œ</h3>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" style="margin: 1.5rem 0; color: var(--text-primary);"></p>
      </div>
      <div class="flex justify-between" style="gap: 1rem;">
        <button type="button" class="btn btn-secondary" style="flex: 1;" id="confirmCancel">å–æ¶ˆ</button>
        <button type="button" class="btn btn-danger" style="flex: 1;" id="confirmOk">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="js/api.js"></script>
  <script src="js/passwordStrength.js"></script>
  <script>
    // Custom Confirm Dialog
    function showConfirm(message) {
      return new Promise((resolve) => {
        const dialog = document.getElementById('confirmDialog');
        const messageEl = document.getElementById('confirmMessage');
        const okBtn = document.getElementById('confirmOk');
        const cancelBtn = document.getElementById('confirmCancel');

        messageEl.textContent = message;
        dialog.classList.add('active');

        function cleanup() {
          dialog.classList.remove('active');
          okBtn.removeEventListener('click', handleOk);
          cancelBtn.removeEventListener('click', handleCancel);
        }

        function handleOk() {
          cleanup();
          resolve(true);
        }

        function handleCancel() {
          cleanup();
          resolve(false);
        }

        okBtn.addEventListener('click', handleOk);
        cancelBtn.addEventListener('click', handleCancel);
      });
    }

    // Override confirm to use custom dialog
    window.confirm = showConfirm;

    // Toast utility function
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ${type === 'success' ? 'background: linear-gradient(135deg, var(--success) 0%, #059669 100%);' : 'background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);'}
      `;
      safeDOM.setText(toast, message);

      container.appendChild(toast);

      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.classList.add('removing');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Override alert to use toast
    window.alert = function(message) {
      showToast(message, 'info');
    };

    // æ£€æŸ¥ç™»å½•å’Œæƒé™
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');

    if (!isLoggedIn()) {
      window.location.href = projectId ? `/?projectId=${projectId}` : '/';
    }

    if (!projectId) {
      alert('ç¼ºå°‘é¡¹ç›®ä¿¡æ¯ï¼Œè¯·é€šè¿‡æ­£ç¡®çš„æ–¹å¼è®¿é—®');
      window.location.href = '/platform/dashboard.html';
    }

    const user = getCurrentUser();
    if (!user || user.role !== 'admin') {
      window.location.href = `/dashboard.html?projectId=${projectId}`;
    }
    document.getElementById('adminName').textContent = user.name;

    // é€€å‡ºç™»å½•
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      clearToken();
      window.location.href = projectId ? `/?projectId=${projectId}` : '/';
    });

    // æ ‡ç­¾åˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    function switchTab(name) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));

      document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
      document.getElementById(name + 'Panel').classList.remove('hidden');

      // åŠ è½½å¯¹åº”æ•°æ®
      if (name === 'overview') loadOverview();
      else if (name === 'time') loadTimeSettings();
      else if (name === 'subjects') loadSubjects();
      else if (name === 'students') loadStudents();
      else if (name === 'stats') loadSelectionList();
      else if (name === 'combinations') loadCombinations();
    }

    // åŠ è½½æ¦‚è§ˆ
    async function loadOverview() {
      const result = await api.selections.getStats();
      if (result.code === 200) {
        const { overview } = result.data;
        document.getElementById('statTotal').textContent = overview.totalStudents;
        document.getElementById('statSubmitted').textContent = overview.submittedCount;
        document.getElementById('statPending').textContent = overview.pendingCount;
        const rate = overview.totalStudents > 0
          ? Math.round(overview.submittedCount / overview.totalStudents * 100)
          : 0;
        document.getElementById('statRate').textContent = rate + '%';
      }
    }

    // åŠ è½½å¹¶åˆå§‹åŒ–æ³¨å†Œå¼€å…³
    async function loadRegistrationStatus() {
      try {
        const result = await request('/admin/registration-setting');

        if (result && result.code === 200) {
          const toggle = document.getElementById('registrationToggle');
          toggle.checked = result.data.registrationEnabled !== false;
        }
      } catch (error) {
        console.error('åŠ è½½æ³¨å†ŒçŠ¶æ€å¤±è´¥:', error);
      }
    }

    // åˆ‡æ¢æ³¨å†Œå¼€å…³
    document.getElementById('registrationToggle').addEventListener('change', async (e) => {
      const enabled = e.target.checked;

      try {
        const result = await request('/admin/registration-setting', {
          method: 'PUT',
          body: JSON.stringify({ enabled })
        });

        if (result && result.code === 200) {
          alert(result.message);
        } else {
          alert(result?.message || 'æ›´æ–°å¤±è´¥');
          e.target.checked = !enabled;
        }
      } catch (error) {
        console.error('åˆ‡æ¢æ³¨å†Œå¼€å…³å¤±è´¥:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        e.target.checked = !enabled;
      }
    });

    // åŠ è½½æ—¶é—´è®¾ç½®
    async function loadTimeSettings() {
      const result = await api.selections.getStatus();
      if (result.code === 200) {
        // è½¬æ¢æ—¶é—´æ ¼å¼ä¸º datetime-local è¾“å…¥æ¡†éœ€è¦çš„æ ¼å¼ (YYYY-MM-DDTHH:mm)
        if (result.data.startTime) {
          const startDate = new Date(result.data.startTime);
          document.getElementById('startTime').value = formatDateTimeLocal(startDate);
        }
        if (result.data.endTime) {
          const endDate = new Date(result.data.endTime);
          document.getElementById('endTime').value = formatDateTimeLocal(endDate);
        }
      }
    }

    // å°†Dateå¯¹è±¡æ ¼å¼åŒ–ä¸ºdatetime-localè¾“å…¥æ¡†éœ€è¦çš„æ ¼å¼
    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }


    // åŠ è½½ç§‘ç›®åˆ—è¡¨
    async function loadSubjects() {
      const result = await api.subjects.getAll();
      const tbody = document.getElementById('subjectsTable');

      if (result.code === 200) {
        const categoryMap = {
          'physics_history': 'é¦–é€‰ç§‘ç›®',
          'four_electives': 'å†é€‰ç§‘ç›®'
        };

        safeDOM.empty(tbody);
        result.data.forEach(s => {
          const tr = safeDOM.createElement('tr', {
            children: [
              safeDOM.createElement('td', {
                children: [safeDOM.createElement('strong', { text: s.name })]
              }),
              safeDOM.createElement('td', {
                children: [safeDOM.createElement('span', {
                  className: 'badge badge-info',
                  text: categoryMap[s.category]
                })]
              }),
              safeDOM.createElement('td', { text: s.description || '-' }),
              safeDOM.createElement('td', { text: s.maxCapacity || 'ä¸é™' }),
              safeDOM.createElement('td', { text: s.currentCount || 0 }),
              safeDOM.createElement('td', {
                children: [safeDOM.createElement('span', {
                  className: s.isActive ? 'badge badge-success' : 'badge badge-danger',
                  text: s.isActive ? 'å¯ç”¨' : 'ç¦ç”¨'
                })]
              }),
              safeDOM.createElement('td', {
                children: [
                  safeDOM.createElement('button', {
                    className: 'btn btn-sm btn-secondary',
                    text: 'ç¼–è¾‘',
                    on: { click: () => editSubject(s.id) }
                  }),
                  document.createTextNode(' '),
                  safeDOM.createElement('button', {
                    className: 'btn btn-sm btn-danger',
                    text: 'åˆ é™¤',
                    on: { click: () => deleteSubject(s.id) }
                  })
                ]
              })
            ]
          });
          tbody.appendChild(tr);
        });
      }
    }

    // ç§‘ç›®å¼¹çª—
    let currentSubjects = [];

    document.getElementById('addSubjectBtn').addEventListener('click', () => {
      document.getElementById('modalTitle').textContent = 'æ·»åŠ ç§‘ç›®';
      document.getElementById('subjectId').value = '';
      document.getElementById('subjectForm').reset();
      document.getElementById('subjectModal').classList.add('active');
    });

    function closeSubjectModal() {
      document.getElementById('subjectModal').classList.remove('active');
    }

    async function editSubject(id) {
      const result = await api.subjects.getById(id);
      if (result.code === 200) {
        const s = result.data;
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç§‘ç›®';
        document.getElementById('subjectId').value = s.id;
        document.getElementById('subjectName').value = s.name;
        document.getElementById('subjectCategory').value = s.category;
        document.getElementById('subjectDesc').value = s.description || '';
        document.getElementById('subjectCapacity').value = s.maxCapacity || 0;
        document.getElementById('subjectModal').classList.add('active');
      }
    }

    async function deleteSubject(id) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç§‘ç›®ï¼Ÿ')) return;
      const result = await api.subjects.delete(id);
      if (result.code === 200) {
        loadSubjects();
      } else {
        alert(result.message);
      }
    }

    document.getElementById('subjectForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('subjectId').value;
      const data = {
        name: document.getElementById('subjectName').value,
        category: document.getElementById('subjectCategory').value,
        description: document.getElementById('subjectDesc').value,
        maxCapacity: parseInt(document.getElementById('subjectCapacity').value) || 0
      };

      let result;
      if (id) {
        result = await api.subjects.update(id, data);
      } else {
        result = await api.subjects.create(data);
      }

      if (result.code === 200) {
        closeSubjectModal();
        loadSubjects();
      } else {
        alert(result.message);
      }
    });

    // åŠ è½½å­¦ç”Ÿåˆ—è¡¨
    let currentPage = 1;
    let classesLoaded = false;

    // åŠ è½½ç­çº§ç­›é€‰é€‰é¡¹
    async function loadClassFilter() {
      if (classesLoaded) return;
      const result = await api.admin.getStudents({ page: 1, limit: 1000 });
      if (result.code === 200) {
        const classes = [...new Set(result.data.data.map(s => s.className).filter(c => c))];
        classes.sort();
        const select = document.getElementById('classFilter');
        classes.forEach(c => {
          const option = document.createElement('option');
          option.value = c;
          option.textContent = c;
          select.appendChild(option);
        });
        classesLoaded = true;
      }
    }

    async function loadStudents(page = 1) {
      currentPage = page;
      await loadClassFilter(); // é¦–æ¬¡åŠ è½½æ—¶å¡«å……ç­çº§ç­›é€‰
      const classFilter = document.getElementById('classFilter').value;
      const params = { page, limit: 15 };
      if (classFilter) params.className = classFilter;
      const result = await api.admin.getStudents(params);
      const tbody = document.getElementById('studentsTable');

      if (result.code === 200) {
        const { data, total, limit } = result.data;

        safeDOM.empty(tbody);
        data.forEach(s => {
          const sel = s.selection;
          const hasSelection = sel && sel.status !== 'cancelled';
          
          const tr = safeDOM.createElement('tr', {
            children: [
              safeDOM.createElement('td', { text: s.studentId }),
              safeDOM.createElement('td', { text: s.name }),
              safeDOM.createElement('td', { text: s.className || '-' }),
              safeDOM.createElement('td', {
                children: [safeDOM.createElement('span', {
                  className: hasSelection ? 'badge badge-success' : 'badge badge-warning',
                  text: hasSelection ? 'å·²é€‰' : 'æœªé€‰'
                })]
              }),
              safeDOM.createElement('td', {
                children: [
                  safeDOM.createElement('div', {
                    className: 'flex gap-1',
                    children: [
                      safeDOM.createElement('button', {
                        className: 'btn btn-sm btn-primary',
                        text: 'ğŸ–Šï¸',
                        attrs: { title: 'ç¼–è¾‘' },
                        on: { click: () => editStudent(s.id) }
                      }),
                      safeDOM.createElement('button', {
                        className: 'btn btn-sm btn-warning',
                        text: 'ğŸ”‘',
                        attrs: { title: 'é‡ç½®å¯†ç ' },
                        on: { click: () => resetPassword(s.id, s.studentId) }
                      }),
                      safeDOM.createElement('button', {
                        className: 'btn btn-sm btn-danger',
                        text: 'ğŸ—‘ï¸',
                        attrs: { title: 'åˆ é™¤' },
                        on: { click: () => deleteStudent(s.id, s.name) }
                      })
                    ]
                  })
                ]
              })
            ]
          });
          tbody.appendChild(tr);
        });

        // åˆ†é¡µ
        const totalPages = Math.ceil(total / limit);
        const pagination = document.getElementById('studentsPagination');
        safeDOM.empty(pagination);
        
        pagination.appendChild(safeDOM.createElement('span', {
          text: `å…± ${total} æ¡è®°å½•`
        }));
        
        const btnGroup = safeDOM.createElement('div', { className: 'flex gap-1' });
        
        if (page > 1) {
          btnGroup.appendChild(safeDOM.createElement('button', {
            className: 'btn btn-sm btn-secondary',
            text: 'ä¸Šä¸€é¡µ',
            on: { click: () => loadStudents(page - 1) }
          }));
        }
        
        btnGroup.appendChild(safeDOM.createElement('span', {
          text: `ç¬¬ ${page}/${totalPages} é¡µ`,
          attrs: { style: 'padding: 0.5rem;' }
        }));
        
        if (page < totalPages) {
          btnGroup.appendChild(safeDOM.createElement('button', {
            className: 'btn btn-sm btn-secondary',
            text: 'ä¸‹ä¸€é¡µ',
            on: { click: () => loadStudents(page + 1) }
          }));
        }
        
        pagination.appendChild(btnGroup);
      }
    }

    document.getElementById('classFilter').addEventListener('change', () => loadStudents(1));

    // å­¦ç”Ÿç®¡ç†åŠŸèƒ½
    let studentPasswordStrength = null;
    
    function openStudentModal(isEdit = false, student = null) {
      const modal = document.getElementById('studentModal');
      modal.classList.add('active');
      document.getElementById('studentModalTitle').textContent = isEdit ? 'ç¼–è¾‘å­¦ç”Ÿ' : 'æ·»åŠ å­¦ç”Ÿ';
      document.getElementById('studentForm').reset();
      document.getElementById('editStudentId').value = '';

      if (isEdit && student) {
        document.getElementById('editStudentId').value = student.id;
        document.getElementById('studentId').value = student.studentId;
        document.getElementById('studentName').value = student.name;
        document.getElementById('studentClass').value = student.className || '';
        document.getElementById('passwordGroup').style.display = 'none';
        
        // ç¼–è¾‘æ¨¡å¼ä¸éœ€è¦å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨
        if (studentPasswordStrength) {
          const container = document.getElementById('studentPasswordStrengthContainer');
          safeDOM.empty(container);
        }
      } else {
        document.getElementById('passwordGroup').style.display = 'block';
        
        // åˆå§‹åŒ–å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨
        setTimeout(() => {
          studentPasswordStrength = new PasswordStrengthIndicator({
            passwordInput: document.getElementById('studentPassword'),
            container: document.getElementById('studentPasswordStrengthContainer')
          });
        }, 100);
      }
    }

    function closeStudentModal() {
      document.getElementById('studentModal').classList.remove('active');
    }

    document.getElementById('addStudentBtn').addEventListener('click', () => {
      openStudentModal(false);
    });

    document.getElementById('studentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const editId = document.getElementById('editStudentId').value;
      const studentId = document.getElementById('studentId').value;
      const name = document.getElementById('studentName').value;
      const className = document.getElementById('studentClass').value;
      const password = document.getElementById('studentPassword').value;

      // å¦‚æœæ˜¯æ–°å¢å­¦ç”Ÿä¸”è®¾ç½®äº†å¯†ç ï¼ŒéªŒè¯å¯†ç å¼ºåº¦
      if (!editId && password && studentPasswordStrength) {
        if (!studentPasswordStrength.isValid()) {
          const errors = studentPasswordStrength.getErrors();
          showToast('å¯†ç ä¸ç¬¦åˆè¦æ±‚ï¼š' + errors.join('ã€'), 'error');
          return;
        }
      }

      try {
        let result;
        if (editId) {
          // ç¼–è¾‘å­¦ç”Ÿ
          result = await api.admin.updateStudent(editId, { studentId, name, className });
        } else {
          // æ·»åŠ å­¦ç”Ÿ
          result = await api.admin.createStudent({ studentId, name, className, password });
        }

        if (result.code === 200) {
          showToast(result.message || (editId ? 'å­¦ç”Ÿä¿¡æ¯æ›´æ–°æˆåŠŸ' : 'å­¦ç”Ÿæ·»åŠ æˆåŠŸ'), 'success');
          closeStudentModal();
          loadStudents(currentPage);
        } else {
          showToast(result.message || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (err) {
        console.error('ä¿å­˜å­¦ç”Ÿé”™è¯¯:', err);
        alert('æ“ä½œå¤±è´¥');
      }
    });

    async function editStudent(id) {
      try {
        const result = await api.admin.getStudents({ page: 1, limit: 1000 });
        const student = result.data.data.find(s => s.id === id);
        if (student) {
          openStudentModal(true, student);
        }
      } catch (err) {
        console.error('è·å–å­¦ç”Ÿä¿¡æ¯é”™è¯¯:', err);
        alert('è·å–å­¦ç”Ÿä¿¡æ¯å¤±è´¥');
      }
    }

    async function deleteStudent(id, name) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤å­¦ç”Ÿ "${name}" å—ï¼Ÿåˆ é™¤åè¯¥å­¦ç”Ÿçš„é€‰ç§‘è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ã€‚`)) {
        return;
      }

      try {
        const result = await api.admin.deleteStudent(id);

        if (result.code === 200) {
          alert('å­¦ç”Ÿåˆ é™¤æˆåŠŸ');
          loadStudents(currentPage);
        } else {
          alert(result.message || 'åˆ é™¤å¤±è´¥');
        }
      } catch (err) {
        console.error('åˆ é™¤å­¦ç”Ÿé”™è¯¯:', err);
        alert('åˆ é™¤å¤±è´¥');
      }
    }

    async function resetPassword(id, studentId) {
      if (!confirm(`ç¡®å®šè¦é‡ç½®è¯¥å­¦ç”Ÿçš„å¯†ç å—ï¼Ÿå¯†ç å°†é‡ç½®ä¸ºå­¦å·ï¼š${studentId}`)) {
        return;
      }

      try {
        const result = await api.admin.resetPassword(id);

        if (result.code === 200) {
          alert(result.message || 'å¯†ç é‡ç½®æˆåŠŸ');
        } else {
          alert(result.message || 'é‡ç½®å¤±è´¥');
        }
      } catch (err) {
        console.error('é‡ç½®å¯†ç é”™è¯¯:', err);
        alert('é‡ç½®å¤±è´¥');
      }
    }

    // åŠ è½½é€‰ç§‘åˆ—è¡¨
    let currentSelectionsPage = 1;
    let selectionsClassesLoaded = false;
    let selectionsCombinationsLoaded = false;

    // åŠ è½½ç­çº§ç­›é€‰é€‰é¡¹
    async function loadSelectionsClassFilter() {
      if (selectionsClassesLoaded) return;
      const result = await api.admin.getStudents({ page: 1, limit: 1000 });
      if (result.code === 200) {
        const classes = [...new Set(result.data.data.map(s => s.className).filter(c => c))];
        classes.sort();
        const select = document.getElementById('selectionsClassFilter');
        classes.forEach(c => {
          const option = document.createElement('option');
          option.value = c;
          option.textContent = c;
          select.appendChild(option);
        });
        selectionsClassesLoaded = true;
      }
    }

    // åŠ è½½ç»„åˆç­›é€‰é€‰é¡¹
    async function loadSelectionsCombinationFilter() {
      if (selectionsCombinationsLoaded) return;
      try {
        const result = await api.selections.getCombinations();
        if (result.code === 200) {
          const combinations = result.data.combinations.map(c => c.combination);
          combinations.sort();
          const select = document.getElementById('selectionsCombinationFilter');
          combinations.forEach(c => {
            const option = document.createElement('option');
            option.value = c;
            option.textContent = c;
            select.appendChild(option);
          });
          selectionsCombinationsLoaded = true;
        }
      } catch (err) {
        console.error('åŠ è½½ç»„åˆé€‰é¡¹å¤±è´¥:', err);
      }
    }

    async function loadSelectionList(page = 1) {
      currentSelectionsPage = page;
      await loadSelectionsClassFilter();
      await loadSelectionsCombinationFilter();

      const classFilter = document.getElementById('selectionsClassFilter').value;
      const combinationFilter = document.getElementById('selectionsCombinationFilter').value;
      const params = { page, limit: 15 };
      if (classFilter) params.className = classFilter;

      const result = await api.selections.getAll(params);
      const tbody = document.getElementById('selectionsTable');

      if (result.code === 200) {
        let { data, total, limit } = result.data;

        // å®¢æˆ·ç«¯ç»„åˆç­›é€‰ï¼ˆå› ä¸ºåç«¯ä¸æ”¯æŒç»„åˆç­›é€‰ï¼‰
        if (combinationFilter) {
          data = data.filter(sel => {
            const ph = sel.physicsHistorySubject?.name || '';
            const electives = [
              sel.electiveOneSubject?.name || '',
              sel.electiveTwoSubject?.name || ''
            ].sort();
            const combination = `${ph} + ${electives.join(' + ')}`;
            return combination === combinationFilter;
          });
          total = data.length; // æ›´æ–°æ€»æ•°
        }

        if (data.length === 0) {
          safeDOM.empty(tbody);
          const tr = safeDOM.createElement('tr', {
            children: [
              safeDOM.createElement('td', {
                attrs: { colspan: '6' },
                className: 'text-center',
                text: 'æš‚æ— æ•°æ®'
              })
            ]
          });
          tbody.appendChild(tr);
        } else {
          safeDOM.empty(tbody);
          data.forEach(sel => {
            const statusMap = {
              'submitted': { className: 'badge badge-primary', text: 'å·²æäº¤' },
              'confirmed': { className: 'badge badge-success', text: 'å·²ç¡®è®¤' },
              'cancelled': { className: 'badge badge-secondary', text: 'å·²å–æ¶ˆ' }
            };
            const submittedAt = sel.submittedAt ? new Date(sel.submittedAt).toLocaleString('zh-CN', {
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit'
            }) : '-';

            // æ„å»ºé€‰ç§‘ç»„åˆ
            const ph = sel.physicsHistorySubject?.name || '-';
            const elec1 = sel.electiveOneSubject?.name || '-';
            const elec2 = sel.electiveTwoSubject?.name || '-';
            const combination = (ph === '-' && elec1 === '-' && elec2 === '-')
              ? '-'
              : `${ph} + ${elec1} + ${elec2}`;

            const statusInfo = statusMap[sel.status] || { className: 'badge', text: '-' };
            
            const tr = safeDOM.createElement('tr', {
              children: [
                safeDOM.createElement('td', { text: sel.user?.studentId || '-' }),
                safeDOM.createElement('td', { text: sel.user?.name || '-' }),
                safeDOM.createElement('td', { text: sel.user?.className || '-' }),
                safeDOM.createElement('td', { text: combination }),
                safeDOM.createElement('td', {
                  children: [safeDOM.createElement('span', {
                    className: statusInfo.className,
                    text: statusInfo.text
                  })]
                }),
                safeDOM.createElement('td', {
                  text: submittedAt,
                  attrs: { style: 'font-family: monospace; font-size: 0.85rem;' }
                })
              ]
            });
            tbody.appendChild(tr);
          });
        }

        // åˆ†é¡µ
        const totalPages = Math.ceil(total / limit);
        const pagination = document.getElementById('selectionsPagination');
        safeDOM.empty(pagination);
        
        pagination.appendChild(safeDOM.createElement('span', {
          text: `å…± ${total} æ¡è®°å½•`
        }));
        
        const btnGroup = safeDOM.createElement('div', { className: 'flex gap-1' });
        
        if (page > 1) {
          btnGroup.appendChild(safeDOM.createElement('button', {
            className: 'btn btn-sm btn-secondary',
            text: 'ä¸Šä¸€é¡µ',
            on: { click: () => loadSelections(page - 1) }
          }));
        }
        
        btnGroup.appendChild(safeDOM.createElement('span', {
          text: `ç¬¬ ${page}/${totalPages} é¡µ`,
          attrs: { style: 'padding: 0.5rem;' }
        }));
        
        if (page < totalPages) {
          btnGroup.appendChild(safeDOM.createElement('button', {
            className: 'btn btn-sm btn-secondary',
            text: 'ä¸‹ä¸€é¡µ',
            on: { click: () => loadSelections(page + 1) }
          }));
        }
        
        pagination.appendChild(btnGroup);
      }
    }

    // ç­›é€‰å™¨å˜åŒ–æ—¶é‡æ–°åŠ è½½
    document.getElementById('selectionsClassFilter').addEventListener('change', () => loadSelectionList(1));
    document.getElementById('selectionsCombinationFilter').addEventListener('change', () => loadSelectionList(1));

    // å¯¼å‡ºé€‰ç§‘åˆ—è¡¨
    document.getElementById('exportSelectionsBtn').addEventListener('click', (e) => {
      e.preventDefault();
      const classFilter = document.getElementById('selectionsClassFilter').value;
      const projectId = new URLSearchParams(window.location.search).get('projectId');
      let url = '/api/selections/export?token=' + getToken() + '&projectId=' + projectId;
      if (classFilter) url += '&className=' + encodeURIComponent(classFilter);
      window.open(url, '_blank');
    });

    // åŠ è½½ç»„åˆç»Ÿè®¡
    async function loadCombinations() {
      const container = document.getElementById('combinationStats');

      try {
        const result = await api.selections.getCombinations();

        if (result.code === 200) {
          const { total, physicsCount, historyCount, combinationCount, combinations } = result.data;

          // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
          document.getElementById('comboTotal').textContent = total;
          document.getElementById('comboPhysics').textContent = physicsCount;
          document.getElementById('comboHistory').textContent = historyCount;
          document.getElementById('comboCount').textContent = combinationCount;

          // ç”Ÿæˆç»„åˆåˆ—è¡¨
          if (combinations.length === 0) {
            safeDOM.setText(container, 'æš‚æ— é€‰ç§‘æ•°æ®');
            container.style.cssText = 'text-align: center; color: var(--text-muted); padding: 2rem;';
            return;
          }

          const maxCount = Math.max(...combinations.map(c => c.count));

          safeDOM.empty(container);
          
          // åˆ›å»ºè¡¨æ ¼åŒ…è£…å™¨
          const tableWrapper = safeDOM.createElement('div', {
            className: 'table-wrapper'
          });
          
          const table = document.createElement('table');
          
          // åˆ›å»ºè¡¨å¤´
          const thead = document.createElement('thead');
          const headerRow = safeDOM.createElement('tr', {
            children: [
              safeDOM.createElement('th', { 
                text: 'æ’å',
                attrs: { style: 'width: 50px;' }
              }),
              safeDOM.createElement('th', { text: 'é€‰ç§‘ç»„åˆ' }),
              safeDOM.createElement('th', { 
                text: 'æ–¹å‘',
                attrs: { style: 'width: 100px;' }
              }),
              safeDOM.createElement('th', { 
                text: 'äººæ•°',
                attrs: { style: 'width: 100px;' }
              }),
              safeDOM.createElement('th', { 
                text: 'å æ¯”',
                attrs: { style: 'width: 200px;' }
              })
            ]
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          
          // åˆ›å»ºè¡¨ä½“
          const tbody = document.createElement('tbody');
          combinations.forEach((c, i) => {
            const percent = total > 0 ? (c.count / total * 100).toFixed(1) : 0;
            const barWidth = maxCount > 0 ? (c.count / maxCount * 100) : 0;
            const isPhysics = c.physicsHistory === 'ç‰©ç†';
            
            const row = safeDOM.createElement('tr', {
              children: [
                safeDOM.createElement('td', {
                  text: String(i + 1),
                  attrs: { style: 'text-align: center; font-weight: 600;' }
                }),
                safeDOM.createElement('td', {
                  children: [safeDOM.createElement('strong', {
                    text: c.combination,
                    attrs: { style: 'font-size: 1.1rem;' }
                  })]
                }),
                safeDOM.createElement('td', {
                  children: [safeDOM.createElement('span', {
                    className: isPhysics ? 'badge badge-info' : 'badge badge-warning',
                    text: (isPhysics ? 'ç‰©ç†' : 'å†å²') + 'æ–¹å‘'
                  })]
                }),
                safeDOM.createElement('td', {
                  attrs: { style: 'text-align: center;' },
                  children: [
                    safeDOM.createElement('strong', {
                      text: String(c.count),
                      attrs: { style: 'font-size: 1.2rem;' }
                    }),
                    document.createTextNode(' '),
                    safeDOM.createElement('span', {
                      text: 'äºº',
                      attrs: { style: 'color: var(--text-muted);' }
                    })
                  ]
                }),
                safeDOM.createElement('td', {
                  children: [
                    safeDOM.createElement('div', {
                      attrs: { style: 'display: flex; align-items: center; gap: 0.5rem;' },
                      children: [
                        safeDOM.createElement('div', {
                          attrs: { 
                            style: `flex: 0 0 ${barWidth}%; height: 24px; background: linear-gradient(90deg, ${isPhysics ? '#3b82f6, #60a5fa' : '#f59e0b, #fbbf24'}); border-radius: 4px; min-width: 2px;`
                          }
                        }),
                        safeDOM.createElement('span', {
                          text: `${percent}%`,
                          attrs: { style: 'font-weight: 600; min-width: 50px;' }
                        })
                      ]
                    })
                  ]
                })
              ]
            });
            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          tableWrapper.appendChild(table);
          container.appendChild(tableWrapper);
          
          // æ·»åŠ ç»Ÿè®¡æ‘˜è¦
          const summary = safeDOM.createElement('div', {
            className: 'mt-4',
            attrs: { style: 'display: flex; gap: 2rem; justify-content: center;' },
            children: [
              safeDOM.createElement('div', {
                attrs: { style: 'text-align: center;' },
                children: [
                  safeDOM.createElement('div', {
                    attrs: {
                      style: 'width: 20px; height: 20px; background: linear-gradient(90deg, #3b82f6, #60a5fa); border-radius: 4px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;'
                    }
                  }),
                  safeDOM.createElement('span', {
                    text: `ç‰©ç†æ–¹å‘: ${physicsCount} äºº (${total > 0 ? (physicsCount / total * 100).toFixed(1) : 0}%)`
                  })
                ]
              }),
              safeDOM.createElement('div', {
                attrs: { style: 'text-align: center;' },
                children: [
                  safeDOM.createElement('div', {
                    attrs: {
                      style: 'width: 20px; height: 20px; background: linear-gradient(90deg, #f59e0b, #fbbf24); border-radius: 4px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;'
                    }
                  }),
                  safeDOM.createElement('span', {
                    text: `å†å²æ–¹å‘: ${historyCount} äºº (${total > 0 ? (historyCount / total * 100).toFixed(1) : 0}%)`
                  })
                ]
              })
            ]
          });
          container.appendChild(summary);
        } else {
          safeDOM.setText(container, 'åŠ è½½å¤±è´¥');
          container.style.cssText = 'text-align: center; color: var(--danger); padding: 2rem;';
        }
      } catch (err) {
        console.error('åŠ è½½ç»„åˆç»Ÿè®¡é”™è¯¯:', err);
        const container = document.getElementById('combinationStats');
        safeDOM.setText(container, 'åŠ è½½å¤±è´¥');
        container.style.cssText = 'text-align: center; color: var(--danger); padding: 2rem;';
      }
    }

    // å¯¼å‡ºç»„åˆç»Ÿè®¡
    document.getElementById('exportCombinationsBtn').addEventListener('click', (e) => {
      e.preventDefault();
      const projectId = new URLSearchParams(window.location.search).get('projectId');
      window.open('/api/selections/combinations/export?token=' + getToken() + '&projectId=' + projectId, '_blank');
    });

    // ============ å­¦ç”Ÿå¯¼å…¥åŠŸèƒ½ ============
    let importData = [];

    // æ‰“å¼€å¯¼å…¥å¼¹çª—
    document.getElementById('importStudentsBtn').addEventListener('click', () => {
      document.getElementById('importModal').classList.add('active');
      resetImportModal();
    });

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('active');
      resetImportModal();
    }

    function resetImportModal() {
      document.getElementById('importFile').value = '';
      document.getElementById('importPreview').style.display = 'none';
      document.getElementById('importPreviewTable').innerHTML = '';
      document.getElementById('importResult').style.display = 'none';
      document.getElementById('importResult').innerHTML = '';
      document.getElementById('submitImportBtn').disabled = true;
      importData = [];
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });

          // æ˜ å°„åˆ—å
          importData = jsonData.map(row => ({
            studentId: String(row['å­¦å·'] || row['studentId'] || '').trim(),
            name: String(row['å§“å'] || row['name'] || '').trim(),
            className: String(row['ç­çº§'] || row['className'] || '').trim(),
            password: String(row['å¯†ç '] || row['password'] || '123456').trim()
          })).filter(s => s.studentId && s.name);

          if (importData.length === 0) {
            alert('æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼');
            return;
          }

          // æ˜¾ç¤ºé¢„è§ˆ
          document.getElementById('previewCount').textContent = importData.length;
          const previewRows = importData.slice(0, 50); // æœ€å¤šæ˜¾ç¤º50æ¡
          document.getElementById('importPreviewTable').innerHTML = previewRows.map(s => `
            <tr>
              <td>${s.studentId}</td>
              <td>${s.name}</td>
              <td>${s.className || '-'}</td>
              <td>${s.password === '123456' ? '(é»˜è®¤)' : '******'}</td>
            </tr>
          `).join('') + (importData.length > 50 ? '<tr><td colspan="4" class="text-center">... è¿˜æœ‰ ' + (importData.length - 50) + ' æ¡æ•°æ®</td></tr>' : '');

          document.getElementById('importPreview').style.display = 'block';
          document.getElementById('submitImportBtn').disabled = false;
        } catch (err) {
          console.error('è§£æExcelé”™è¯¯:', err);
          alert('è§£æExcelæ–‡ä»¶å¤±è´¥: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ä¸‹è½½æ¨¡æ¿
    function downloadTemplate() {
      const templateData = [
        { 'å­¦å·': '2024001', 'å§“å': 'å¼ ä¸‰', 'ç­çº§': 'é«˜ä¸€1ç­', 'å¯†ç ': '123456' },
        { 'å­¦å·': '2024002', 'å§“å': 'æå››', 'ç­çº§': 'é«˜ä¸€1ç­', 'å¯†ç ': '' },
        { 'å­¦å·': '2024003', 'å§“å': 'ç‹äº”', 'ç­çº§': 'é«˜ä¸€2ç­', 'å¯†ç ': '' }
      ];
      const ws = XLSX.utils.json_to_sheet(templateData);
      ws['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 12 }, { wch: 10 }];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'å­¦ç”Ÿåå•');
      XLSX.writeFile(wb, 'å­¦ç”Ÿå¯¼å…¥æ¨¡æ¿.xlsx');
    }

    // æäº¤å¯¼å…¥
    async function submitImport() {
      if (importData.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
        return;
      }

      const btn = document.getElementById('submitImportBtn');
      btn.disabled = true;
      btn.textContent = 'å¯¼å…¥ä¸­...';

      try {
        const result = await api.admin.importStudents(importData);
        const resultDiv = document.getElementById('importResult');

        if (result.code === 200) {
          const { success, failed, errors } = result.data;
          let html = `<div class="alert" style="background: var(--success); color: white; padding: 1rem; border-radius: 8px;">
            <strong>âœ… å¯¼å…¥å®Œæˆ</strong><br>
            æˆåŠŸ: ${success} äººï¼Œå¤±è´¥: ${failed} äºº
          </div>`;

          if (errors && errors.length > 0) {
            html += `<div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; font-size: 0.85rem; color: var(--danger);">
              ${errors.slice(0, 10).map(e => `<div>â€¢ ${e}</div>`).join('')}
              ${errors.length > 10 ? `<div>... è¿˜æœ‰ ${errors.length - 10} æ¡é”™è¯¯</div>` : ''}
            </div>`;
          }

          resultDiv.innerHTML = html;
          resultDiv.style.display = 'block';

          // åˆ·æ–°å­¦ç”Ÿåˆ—è¡¨
          loadStudents(1);

          // å»¶è¿Ÿå…³é—­å¼¹çª—
          setTimeout(() => {
            closeImportModal();
          }, 2000);
        } else {
          const resultDiv = document.getElementById('importResult');
          safeDOM.empty(resultDiv);
          
          const errorDiv = safeDOM.createElement('div', {
            className: 'alert',
            attrs: {
              style: 'background: var(--danger); color: white; padding: 1rem; border-radius: 8px;'
            },
            children: [
              safeDOM.createElement('strong', { text: 'âœ— å¯¼å…¥å¤±è´¥' }),
              safeDOM.createElement('p', { text: result.message || 'æœªçŸ¥é”™è¯¯' })
            ]
          });
          resultDiv.appendChild(errorDiv);
        }
        resultDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'å¼€å§‹å¯¼å…¥';
      } catch (err) {
        console.error('å¯¼å…¥é”™è¯¯:', err);
        alert('å¯¼å…¥å¤±è´¥: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'å¼€å§‹å¯¼å…¥';
      }
    }
    // æ—¶é—´è®¾ç½®è¡¨å•æäº¤
    document.getElementById('timeForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      if (!startTime || !endTime) {
        alert('è¯·å¡«å†™å®Œæ•´çš„æ—¶é—´è®¾ç½®');
        return;
      }

      if (new Date(endTime) <= new Date(startTime)) {
        alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´');
        return;
      }

      try {
        const result = await api.admin.setSelectionTime(startTime, endTime);
        if (result.code === 200) {
          alert('æ—¶é—´è®¾ç½®å·²æ›´æ–°');
          loadOverview();
        } else {
          alert(result.message || 'æ›´æ–°å¤±è´¥');
        }
      } catch (err) {
        console.error('æ›´æ–°é”™è¯¯:', err);
        alert('æ›´æ–°å¤±è´¥');
      }
    });


    // åˆå§‹åŒ–
    loadOverview();
    loadRegistrationStatus(); // åŠ è½½æ³¨å†Œå¼€å…³çŠ¶æ€
  </script>
</body>
</html>
