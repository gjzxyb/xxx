<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¶…çº§ç®¡ç†å‘˜ - åˆ†ç§‘è‡ªé€‰ SaaS å¹³å°</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="page-wrapper">
    <nav class="navbar">
      <div class="container navbar-content">
        <div class="navbar-brand">
          <span>ğŸ“</span>
          <span>åˆ†ç§‘è‡ªé€‰å¹³å° - è¶…çº§ç®¡ç†å‘˜</span>
        </div>
        <div class="navbar-nav">
          <div class="nav-user">
            <span id="userName"></span>
            <button class="btn btn-sm btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
          </div>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="container">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalUsers">-</div>
            <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalProjects">-</div>
            <div class="stat-label">æ€»é¡¹ç›®æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="recentUsers">-</div>
            <div class="stat-label">æ–°å¢ç”¨æˆ·(7å¤©)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="recentProjects">-</div>
            <div class="stat-label">æ–°å¢é¡¹ç›®(7å¤©)</div>
          </div>
        </div>

        <!-- ç”¨æˆ·ç®¡ç† -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ç”¨æˆ·ç®¡ç†</h3>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>é‚®ç®±</th>
                  <th>å§“å</th>
                  <th>é¡¹ç›®æ•°</th>
                  <th>é¡¹ç›®é™é¢</th>
                  <th>æ³¨å†Œæ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="usersTable">
                <tr><td colspan="7" class="text-center">åŠ è½½ä¸­...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- å¹³å°é…ç½® -->
        <div class="card" style="margin-top: 2rem;">
          <div class="card-header">
            <h3 class="card-title">å¹³å°é…ç½®</h3>
          </div>
          <form id="configForm">
            <div class="form-group">
              <label class="form-label">æ–°ç”¨æˆ·é»˜è®¤é¡¹ç›®é™é¢</label>
              <input type="number" id="defaultMaxProjects" class="form-input" min="1" required>
            </div>
            <div class="form-group">
              <label class="form-label">å…è®¸æ³¨å†Œçš„é‚®ç®±åŸŸåï¼ˆé€—å·åˆ†éš”ï¼Œç•™ç©ºä¸é™åˆ¶ï¼‰</label>
              <input type="text" id="allowedEmailDomains" class="form-input" placeholder="ä¾‹å¦‚ï¼šexample.com, school.edu">
            </div>
            <button type="submit" class="btn btn-success">ä¿å­˜é…ç½®</button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- ä¿®æ”¹é™é¢å¼¹çª— -->
  <div class="modal-overlay" id="editLimitModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">ä¿®æ”¹é¡¹ç›®é™é¢</h3>
        <button class="modal-close" onclick="closeEditLimitModal()">&times;</button>
      </div>
      <form id="editLimitForm">
        <input type="hidden" id="editUserId">
        <div class="form-group">
          <label class="form-label">ç”¨æˆ·</label>
          <input type="text" id="editUserEmail" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">é¡¹ç›®é™é¢</label>
          <input type="number" id="editMaxProjects" class="form-input" min="0" required>
        </div>
        <div class="flex justify-between">
          <button type="button" class="btn btn-secondary" onclick="closeEditLimitModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-success">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('platform_token');
    const user = JSON.parse(localStorage.getItem('platform_user') || '{}');

    if (!token || !user.isSuperAdmin) {
      window.location.href = 'login.html';
    }

    document.getElementById('userName').textContent = user.name;

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const response = await fetch('/api/superadmin/stats', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const result = await response.json();

        if (result.code === 200) {
          document.getElementById('totalUsers').textContent = result.data.totalUsers;
          document.getElementById('totalProjects').textContent = result.data.totalProjects;
          document.getElementById('recentUsers').textContent = result.data.recentUsers;
          document.getElementById('recentProjects').textContent = result.data.recentProjects;
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      }
    }

    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    async function loadUsers() {
      try {
        const response = await fetch('/api/superadmin/users', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const result = await response.json();

        if (result.code === 200) {
          const usersHtml = result.data.map(u => `
            <tr>
              <td>${u.id}</td>
              <td>${u.email}</td>
              <td>${u.name}</td>
              <td>${u.projectCount}</td>
              <td>${u.maxProjects}</td>
              <td>${new Date(u.createdAt).toLocaleString('zh-CN')}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="editUserLimit(${u.id}, '${u.email}', ${u.maxProjects})">ä¿®æ”¹é™é¢</button>
              </td>
            </tr>
          `).join('');

          document.getElementById('usersTable').innerHTML = usersHtml;
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
      }
    }

    // åŠ è½½é…ç½®
    async function loadConfig() {
      try {
        const response = await fetch('/api/superadmin/config', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const result = await response.json();

        if (result.code === 200) {
          const configs = result.data.reduce((acc, c) => ({ ...acc, [c.key]: c.value }), {});
          document.getElementById('defaultMaxProjects').value = configs.default_max_projects || 3;
          document.getElementById('allowedEmailDomains').value = configs.allowed_email_domains || '';
        }
      } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
      }
    }

    // ä¿å­˜é…ç½®
    document.getElementById('configForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const defaultMaxProjects = document.getElementById('defaultMaxProjects').value;
      const allowedEmailDomains = document.getElementById('allowedEmailDomains').value;

      try {
        await Promise.all([
          fetch('/api/superadmin/config', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              key: 'default_max_projects',
              value: defaultMaxProjects,
              description: 'æ–°ç”¨æˆ·é»˜è®¤é¡¹ç›®æ•°é‡é™åˆ¶'
            })
          }),
          fetch('/api/superadmin/config', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              key: 'allowed_email_domains',
              value: allowedEmailDomains,
              description: 'å…è®¸æ³¨å†Œçš„é‚®ç®±åŸŸå'
            })
          })
        ]);

        alert('é…ç½®ä¿å­˜æˆåŠŸ');
      } catch (error) {
        console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    });

    // ä¿®æ”¹ç”¨æˆ·é™é¢
    function editUserLimit(userId, email, maxProjects) {
      document.getElementById('editUserId').value = userId;
      document.getElementById('editUserEmail').value = email;
      document.getElementById('editMaxProjects').value = maxProjects;
      document.getElementById('editLimitModal').classList.add('active');
    }

    function closeEditLimitModal() {
      document.getElementById('editLimitModal').classList.remove('active');
    }

    document.getElementById('editLimitForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const userId = document.getElementById('editUserId').value;
      const maxProjects = document.getElementById('editMaxProjects').value;

      try {
        const response = await fetch(`/api/superadmin/users/${userId}/max-projects`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ maxProjects: parseInt(maxProjects) })
        });

        const result = await response.json();

        if (result.code === 200) {
          alert('é™é¢ä¿®æ”¹æˆåŠŸ');
          closeEditLimitModal();
          loadUsers();
        } else {
          alert(result.message || 'ä¿®æ”¹å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿®æ”¹é™é¢å¤±è´¥:', error);
        alert('ä¿®æ”¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    });

    function logout() {
      localStorage.removeItem('platform_token');
      localStorage.removeItem('platform_user');
      window.location.href = 'login.html';
    }

    loadStats();
    loadUsers();
    loadConfig();
  </script>
</body>
</html>
